<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Checklist Di√°rio T.I Solar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="icone.ico" type="image/x-icon">
  <style>
    :root {
      --bg-color: #121212;
      --card-color: #1e1e1e;
      --text-color: #e0e0e0;
      --accent: #00ffcc;
      --scroll-track: #0f0f0f;
      --scroll-thumb: #00ffcc33;
      --scroll-thumb-hover: #00ffcc77;
    }
    body.light {
      --bg-color: #f0f0f0;
      --card-color: #ffffff;
      --text-color: #111111;
      --accent: #00796b;
      --scroll-track: #e9e9e9;
      --scroll-thumb: #00796b33;
      --scroll-thumb-hover: #00796b77;
      background-image: none;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-image: url('fundo.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      z-index: -1;
    }
    header {
      position: relative;
      padding: 20px 40px;
    }
    h1 {
      text-align: center;
      font-size: 3em;
      color: var(--accent);
      margin: 0;
    }
    .info {
      position: absolute;
      top: 20px;
      right: 40px;
      text-align: right;
      font-size: 1em;
      display: grid;
      gap: 6px;
    }
    .controls {
      position: absolute;
      top: 20px;
      left: 40px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .main-controls,
    .secondary-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button {
      background-color: var(--card-color);
      color: var(--text-color);
      border: 1px solid var(--accent);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background-color: var(--accent);
      color: #000;
    }
    main { padding: 40px; }
    .container-flex {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
    }
    .checklist {
      flex: 1;
      min-width: 300px;
    }
    .relatorio {
      flex: 1;
      min-width: 300px;
      background-color: var(--card-color);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--accent);
    }

    table { width: 100%; border-collapse: collapse; color: var(--text-color); }
    th, td { border: 1px solid var(--accent); padding: 8px; text-align: left; vertical-align: top; }
    th { background-color: var(--accent); color: black; }
    ul {
      list-style-type: decimal;
      padding-left: 20px;
      margin: 0;
      max-width: 700px;
    }
    li {
      background-color: var(--card-color);
      margin-bottom: 20px;
      padding: 20px;
      border-radius: 10px;
      font-size: 1.5em;
    }
    li label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      border-left: 5px solid var(--accent);
      padding-left: 10px;
    }
    li span { transition: color 0.3s ease, text-decoration 0.3s ease; }
    input[type="checkbox"] {
      transform: scale(1.5);
      cursor: pointer;
      accent-color: var(--accent);
    }
    .checked { text-decoration: line-through; color: gray; }
    .checked::after { content: " ‚úîÔ∏è"; font-size: 0.8em; }

    .historico {
      background-color: var(--card-color);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--accent);
      margin-top: 40px;
    }
    .filtros {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .table-wrap {
      max-height: 320px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid var(--accent);
    }
    .table-wrap table { border: none; }
    .table-wrap::-webkit-scrollbar { width: 10px; }
    .table-wrap::-webkit-scrollbar-track { background: var(--scroll-track); border-radius: 10px; }
    .table-wrap::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 10px; }
    .table-wrap::-webkit-scrollbar-thumb:hover { background: var(--scroll-thumb-hover); }

    .subwifi {
      margin-top: 14px;
      padding: 14px;
      border: 1px dashed var(--accent);
      border-radius: 10px;
      background: rgba(0,0,0,0.2);
      display: none;
    }
    .subwifi .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 10px;
    }
    .subwifi label {
      font-size: 0.9em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: var(--card-color);
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .subwifi input[type="number"] {
      width: 110px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--accent);
      background: #00000033;
      color: var(--text-color);
      font-size: 0.95em;
    }
    .hint { margin-top: 8px; font-size: 0.85em; opacity: 0.8; }

    /* ===== Mobile-first ajustes ===== */
    @media (max-width: 768px) {
      header { padding: 16px; }

      h1 {
        font-size: 1.8em;
        margin-top: 58px; /* abre espa√ßo para barra fixa */
      }

      .controls {
        position: fixed;
        top: 10px;
        left: 10px;
        right: 10px;
        flex-direction: row;
        justify-content: space-between;
        gap: 10px;
        z-index: 10;
        padding: 8px;
        border-radius: 12px;
        background: rgba(0,0,0,0.55);
        backdrop-filter: blur(6px);
      }

      .main-controls, .secondary-controls {
        flex: 1;
        justify-content: space-between;
      }

      button {
        width: 100%;
        padding: 10px 12px;
        font-size: 0.95em;
      }

      .info {
        position: static;
        margin-top: 10px;
        text-align: left;
        font-size: 0.95em;
        display: grid;
        gap: 6px;
      }

      main { padding: 16px; }

      .container-flex { flex-direction: column; gap: 16px; }

      ul { padding-left: 18px; max-width: 100%; }

      li { font-size: 1.05em; padding: 14px; margin-bottom: 12px; }

      input[type="checkbox"] { transform: scale(1.3); }

      .subwifi .grid { grid-template-columns: 1fr; }

      .relatorio, .historico { padding: 14px; }

      .table-wrap { max-height: 260px; }

      .historico[data-collapsed="true"] .table-wrap,
      .historico[data-collapsed="true"] .filtros { display: none; }

      #graficoWifi { height: 240px !important; }
    }
  </style>
</head>

<body>

  <!-- Modal Operador -->
  <div id="modalOperador" style="
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.75);
    display: none; align-items: center; justify-content: center;
    z-index: 9999; padding: 16px;">
    <div style="
      width: 100%; max-width: 420px;
      background: var(--card-color);
      border: 1px solid var(--accent);
      border-radius: 14px;
      padding: 18px;">
      <h2 style="margin:0 0 10px 0; color: var(--accent);">Identifica√ß√£o do Operador</h2>
      <p style="margin:0 0 12px 0; opacity:0.9;">
        Informe seu nome para registrar as conclus√µes no relat√≥rio.
      </p>

      <input id="inputOperador" type="text" placeholder="Ex.: Jo√£o Silva" autocomplete="name"
        style="
          width:100%; padding: 12px 12px;
          border-radius: 10px;
          border: 1px solid var(--accent);
          background: #00000033;
          color: var(--text-color);
          font-size: 1em;
          outline: none;
        ">

      <div style="display:flex; gap:10px; margin-top:12px;">
        <button style="flex:1;" onclick="confirmarOperador()">Entrar</button>
        <button style="flex:1;" onclick="trocarOperador()">Trocar</button>
      </div>

      <div style="margin-top:10px; font-size:0.9em; opacity:0.8;">
        Dica: o nome fica salvo neste dispositivo.
      </div>
    </div>
  </div>

  <header>
    <div class="controls">
      <div class="main-controls">
        <button onclick="alternarTema()">üåó Alternar Tema</button>
      </div>
      <div class="secondary-controls">
        <button onclick="resetarChecklist()">üîÅ Resetar Checklist</button>
      </div>
    </div>
    <h1>Checklist Di√°rio T.I Solar</h1>
    <div class="info">
      <span id="operador">üë§ Operador: (n√£o informado)</span>
      <span id="hora">‚è∞ Carregando hora...</span>
      <span id="clima">üå°Ô∏è Carregando clima...</span>
    </div>
  </header>

  <main>
    <div class="container-flex">
      <div class="checklist">
        <ul id="checklist">
          <li>
            <input type="checkbox" id="tarefa1" onclick="registrarConclusao(this)">
            <label for="tarefa1"><span>Verificar equipamentos do Data Center</span></label>
          </li>
          <li>
            <input type="checkbox" id="tarefa2" onclick="registrarConclusao(this)">
            <label for="tarefa2"><span>Validar a disponibilidade dos canais de TV</span></label>
          </li>
          <li>
            <input type="checkbox" id="tarefa3" onclick="registrarConclusao(this)">
            <label for="tarefa3"><span>Validar chamados em aberto</span></label>
          </li>
          <li>
            <input type="checkbox" id="tarefa4" onclick="registrarConclusao(this)">
            <label for="tarefa4"><span>Validar as telas com banner do marketing na recep√ß√£o</span></label>
          </li>

          <li id="li-wifi">
            <input type="checkbox" id="tarefa5" onclick="registrarConclusao(this)">
            <label for="tarefa5"><span>Realizar testes de Wi-Fi em √°reas comuns</span></label>

            <div id="subwifi" class="subwifi">
              <div class="grid">
                <label>Recep√ß√£o
                  <input type="number" id="wifi-recepcao" min="0" step="1" inputmode="numeric" placeholder="Mbps">
                </label>
                <label>Minigolf
                  <input type="number" id="wifi-minigolf" min="0" step="1" inputmode="numeric" placeholder="Mbps">
                </label>
                <label>Sorveteria
                  <input type="number" id="wifi-sorveteria" min="0" step="1" inputmode="numeric" placeholder="Mbps">
                </label>
                <label>Bar Piscina
                  <input type="number" id="wifi-barpiscina" min="0" step="1" inputmode="numeric" placeholder="Mbps">
                </label>
                <label>Pizzaria
                  <input type="number" id="wifi-pizzaria" min="0" step="1" inputmode="numeric" placeholder="Mbps">
                </label>
                <label>Pastelaria
                  <input type="number" id="wifi-pastelaria" min="0" step="1" inputmode="numeric" placeholder="Mbps">
                </label>
              </div>
              <div class="hint">Preencha todos os 6 campos. A tarefa s√≥ ser√° conclu√≠da quando todos estiverem preenchidos.</div>
            </div>
          </li>

          <li>
            <input type="checkbox" id="tarefa6" onclick="registrarConclusao(this)">
            <label for="tarefa6"><span>Verificar TVs com Pix Media nas √Åreas</span></label>
          </li>
        </ul>
      </div>

      <div class="relatorio">
        <h2>‚úÖ Relat√≥rio de Conclus√£o (Hoje)</h2>
        <div class="table-wrap">
          <table id="tabelaRelatorio">
            <thead>
              <tr><th>Tarefa</th><th>Operador</th><th>Data e Hora</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- =========================
             GR√ÅFICO WIFI (Hoje)
             ========================= -->
        <div style="margin-top: 16px;">
          <h3 style="margin: 0 0 10px 0;">üì∂ Wi-Fi (Hoje) ‚Äî Manh√£ x Tarde</h3>

          <div style="font-size: 0.9em; opacity: 0.85; margin-bottom: 8px;">
            Manh√£: 06:00‚Äì11:59 | Tarde: 12:00‚Äì18:00
          </div>

          <div style="background: rgba(0,0,0,0.12); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 12px;">
            <canvas id="graficoWifi" width="900" height="280" style="width: 100%; height: 280px;"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="historico">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
        <h2 style="margin:0;">üìú Hist√≥rico de Relat√≥rios</h2>
        <div style="display:flex; gap:10px; flex-wrap: wrap;">
          <button onclick="toggleHistorico()">Mostrar/Ocultar</button>
          <button onclick="exportarPDF()">üìÑ Exportar PDF</button>
        </div>
      </div>

      <div class="filtros">
        <select id="filtroDia"><option value="">Dia</option></select>
        <select id="filtroMes"><option value="">M√™s</option></select>
        <select id="filtroAno"><option value="">Ano</option></select>
        <button onclick="aplicarFiltroHistorico()">Filtrar</button>
        <button onclick="limparFiltroHistorico()">Limpar Filtros</button>
      </div>

      <div class="table-wrap">
        <table id="tabelaHistorico">
          <thead>
            <tr><th>Tarefa</th><th>Operador</th><th>Data e Hora</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://bldwliqnvrjsndgnaqlr.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsZHdsaXFudnJqc25kZ25hcWxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2MDMwNjEsImV4cCI6MjA4MjE3OTA2MX0.HWd_vdg7-0dmDDX2P-Xo8CsqTT67bUI01VhPcUvnyds";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  let relatorioCache = [];
  let operadorAtual = "";

  const WIFI_INPUT_IDS = [
    "wifi-recepcao","wifi-minigolf","wifi-sorveteria",
    "wifi-barpiscina","wifi-pizzaria","wifi-pastelaria"
  ];

  function getOperador() {
    return (localStorage.getItem("operadorTI") || "").trim();
  }

  function setOperador(nome) {
    operadorAtual = (nome || "").trim();
    localStorage.setItem("operadorTI", operadorAtual);
    const el = document.getElementById("operador");
    if (el) el.textContent = `üë§ Operador: ${operadorAtual || "(n√£o informado)"}`;
  }

  function abrirModalOperador(force=false) {
    const nome = getOperador();
    if (!force && nome) {
      setOperador(nome);
      return;
    }
    const modal = document.getElementById("modalOperador");
    modal.style.display = "flex";
    const input = document.getElementById("inputOperador");
    input.value = force ? "" : nome;
    setTimeout(() => input.focus(), 50);
  }

  window.confirmarOperador = function() {
    const nome = document.getElementById("inputOperador").value.trim();
    if (!nome) { alert("Informe o nome do operador."); return; }
    setOperador(nome);
    document.getElementById("modalOperador").style.display = "none";
    salvarEstado();
  };

  window.trocarOperador = function() {
    abrirModalOperador(true);
  };

  window.toggleHistorico = function() {
    const box = document.querySelector(".historico");
    const v = box.getAttribute("data-collapsed") === "true";
    box.setAttribute("data-collapsed", v ? "false" : "true");
  };

  function dataHojeBR() {
    const hoje = new Date();
    return hoje.toLocaleDateString("pt-BR", { timeZone: 'America/Sao_Paulo' });
  }

  function atualizarHora() {
    const data = new Date();
    const opcoes = { timeZone: 'America/Sao_Paulo', hour: '2-digit', minute: '2-digit', second: '2-digit' };
    document.getElementById('hora').textContent =
      `‚è∞ Hor√°rio de Bras√≠lia: ${new Intl.DateTimeFormat('pt-BR', opcoes).format(data)}`;
  }
  setInterval(atualizarHora, 1000);
  atualizarHora();

  async function salvarNoSupabase(checklist, relatorio, wifi, operador) {
    try {
      const { error } = await supabase
        .from("relatorio_t")
        .upsert({
          id: 1,
          checklist,
          relatorio,
          wifi,
          operador,
          atualizado_em: new Date().toISOString()
        })
        .select();
      if (error) throw error;
    } catch (err) {
      console.warn("Erro ao salvar no Supabase, fallback localStorage:", err);
      localStorage.setItem("estadoChecklistTI", JSON.stringify({ checklist, relatorio, wifi, operador }));
    }
  }

  async function carregarDoSupabase() {
    try {
      const { data, error } = await supabase
        .from("relatorio_t")
        .select("*")
        .eq("id", 1)
        .single();
      if (error || !data) throw error || new Error("Sem dados");
      return {
        checklist: data.checklist || [],
        relatorio: data.relatorio || [],
        wifi: data.wifi || null,
        operador: data.operador || ""
      };
    } catch (err) {
      console.warn("Erro ao carregar do Supabase, usando localStorage:", err);
      return JSON.parse(localStorage.getItem("estadoChecklistTI")) || null;
    }
  }

  function coletarValoresWifi() {
    const vals = {};
    WIFI_INPUT_IDS.forEach(id => {
      const el = document.getElementById(id);
      vals[id] = el?.value?.trim() ?? "";
    });
    return vals;
  }

  function preencherValoresWifi(vals) {
    if (!vals) return;
    WIFI_INPUT_IDS.forEach(id => {
      if (vals[id] !== undefined) {
        const el = document.getElementById(id);
        el.value = vals[id];
      }
    });
  }

  function anyWifiPreenchido(vals) {
    return Object.values(vals || {}).some(v => (v ?? "").toString().trim() !== "");
  }

  function todosWifiPreenchidos() {
    return WIFI_INPUT_IDS.every(id => {
      const v = (document.getElementById(id).value || "").trim();
      return v !== "" && !isNaN(Number(v));
    });
  }

  async function salvarEstado() {
    const checklist = [...document.querySelectorAll("#checklist li")].map(li => {
      const span = li.querySelector("span");
      const checkbox = li.querySelector('input[type="checkbox"]');
      const tarefa = (span?.textContent || "").replace(" ‚úîÔ∏è", "");
      const marcado = checkbox?.checked || false;
      return { id: checkbox?.id || "", tarefa, marcado };
    });
    const wifi = coletarValoresWifi();
    const operador = getOperador() || operadorAtual || "";
    await salvarNoSupabase(checklist, relatorioCache, wifi, operador);
  }

  function desenharRelatorioHoje() {
    const corpo = document.querySelector("#tabelaRelatorio tbody");
    corpo.innerHTML = "";
    relatorioCache.forEach(reg => {
      if ((reg.dataHora || "").startsWith(dataHojeBR())) {
        const row = corpo.insertRow();
        row.insertCell(0).textContent = reg.tarefa;
        row.insertCell(1).textContent = reg.operador || "";
        row.insertCell(2).textContent = reg.dataHora;
      }
    });
  }

  function aplicarChecklistSalvo(salvoChecklist) {
    if (!Array.isArray(salvoChecklist)) return;

    salvoChecklist.forEach(itemSalvo => {
      // novo formato: id
      if (itemSalvo?.id) {
        const cb = document.getElementById(itemSalvo.id);
        if (cb) {
          cb.checked = !!itemSalvo.marcado;
          const sp = cb.parentElement?.querySelector("span");
          if (sp) sp.classList.toggle("checked", !!itemSalvo.marcado);
          return;
        }
      }
      // fallback: formato antigo por texto (aproxima√ß√£o)
      document.querySelectorAll("#checklist li").forEach(li => {
        const span = li.querySelector("span");
        if (span && itemSalvo?.tarefa && span.textContent.includes(itemSalvo.tarefa)) {
          const checkbox = li.querySelector('input[type="checkbox"]');
          checkbox.checked = !!itemSalvo.marcado;
          span.classList.toggle("checked", !!itemSalvo.marcado);
        }
      });
    });
  }

  // =========================
  // GR√ÅFICO WIFI (Canvas puro)
  // =========================
  const WIFI_AREAS = ["Recep√ß√£o","Minigolf","Sorveteria","Bar Piscina","Pizzaria","Pastelaria"];

  function parseHoraBR(dataHoraStr) {
    // dataHoraStr t√≠pico: "25/01/2026 14:33:21"
    if (!dataHoraStr) return null;
    const parts = dataHoraStr.split(" ");
    if (parts.length < 2) return null;
    const hora = parts[1].split(":");
    if (hora.length < 2) return null;
    const h = Number(hora[0]);
    const m = Number(hora[1]);
    if (Number.isNaN(h) || Number.isNaN(m)) return null;
    return { h, m };
  }

  function isHojeBR(dataHoraStr) {
    return (dataHoraStr || "").startsWith(dataHojeBR());
  }

  function periodoDia(dataHoraStr) {
    const t = parseHoraBR(dataHoraStr);
    if (!t) return null;
    const minutos = t.h * 60 + t.m;

    // Manh√£: 06:00‚Äì11:59
    if (minutos >= 360 && minutos <= 719) return "manha";

    // Tarde: 12:00‚Äì18:00
    if (minutos >= 720 && minutos <= 1080) return "tarde";

    return null;
  }

  function extrairMbpsWifi(descricao) {
    // "Realizar testes de Wi-Fi em √°reas comuns: Recep√ß√£o - 12 Mbps, ..."
    if (!descricao) return null;

    const out = {};
    WIFI_AREAS.forEach(area => {
      const re = new RegExp(area.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + "\\s*-\\s*(\\d+(?:[\\.,]\\d+)?)\\s*Mbps", "i");
      const m = descricao.match(re);
      if (m && m[1] != null) {
        const v = Number(String(m[1]).replace(",", "."));
        if (!Number.isNaN(v)) out[area] = v;
      }
    });

    return out;
  }

  function consolidarWifiHoje(relatorio) {
    // pega o registro mais recente de cada per√≠odo (manh√£/tarde)
    let manha = null;
    let tarde = null;

    for (const reg of relatorio) {
      if (!reg || !isHojeBR(reg.dataHora)) continue;
      if (!String(reg.tarefa || "").toLowerCase().includes("realizar testes de wi-fi")) continue;

      const p = periodoDia(reg.dataHora);
      if (!p) continue;

      const valores = extrairMbpsWifi(reg.tarefa);
      if (!valores) continue;

      if (p === "manha" && !manha) manha = { valores, dataHora: reg.dataHora };
      if (p === "tarde" && !tarde) tarde = { valores, dataHora: reg.dataHora };

      if (manha && tarde) break;
    }

    return { manha, tarde };
  }

  function desenharGraficoWifi() {
    const canvas = document.getElementById("graficoWifi");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const { manha, tarde } = consolidarWifiHoje(relatorioCache);

    const padding = { left: 55, right: 20, top: 16, bottom: 40 };
    const w = canvas.width;
    const h = canvas.height;
    const plotW = w - padding.left - padding.right;
    const plotH = h - padding.top - padding.bottom;

    const yMin = 0;
    const yMax = 20;

    function yToPx(v) {
      const clamped = Math.max(yMin, Math.min(yMax, v));
      const t = (clamped - yMin) / (yMax - yMin);
      return padding.top + (plotH * (1 - t));
    }

    function xToPx(i) {
      const step = plotW / (WIFI_AREAS.length - 1);
      return padding.left + i * step;
    }

    const corManha = "#00ffcc";
    const corTarde = "#ffcc00";

    // grade + eixos
    ctx.save();
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(255,255,255,0.15)";
    ctx.fillStyle = "rgba(255,255,255,0.75)";
    ctx.font = "12px Arial";

    const ticks = [1, 5, 10, 15, 20];
    ticks.forEach(tv => {
      const y = yToPx(tv);
      ctx.beginPath();
      ctx.moveTo(padding.left, y);
      ctx.lineTo(w - padding.right, y);
      ctx.stroke();
      ctx.fillText(String(tv), 10, y + 4);
    });

    ctx.strokeStyle = "rgba(255,255,255,0.25)";
    ctx.beginPath();
    ctx.moveTo(padding.left, yToPx(0));
    ctx.lineTo(w - padding.right, yToPx(0));
    ctx.stroke();

    ctx.fillStyle = "rgba(255,255,255,0.85)";
    WIFI_AREAS.forEach((label, i) => {
      const x = xToPx(i);
      ctx.save();
      ctx.translate(x, h - 16);
      ctx.rotate(-Math.PI / 8);
      ctx.fillText(label, -20, 0);
      ctx.restore();
    });

    ctx.restore();

    function drawSeries(valoresMap, cor) {
      const pts = WIFI_AREAS.map((area, i) => {
        const v = valoresMap && valoresMap[area] != null ? Number(valoresMap[area]) : null;
        if (v == null || Number.isNaN(v)) return null;
        return { x: xToPx(i), y: yToPx(v), v };
      });

      ctx.save();
      ctx.strokeStyle = cor;
      ctx.lineWidth = 3;
      ctx.beginPath();
      let started = false;
      pts.forEach(p => {
        if (!p) return;
        if (!started) { ctx.moveTo(p.x, p.y); started = true; }
        else ctx.lineTo(p.x, p.y);
      });
      ctx.stroke();

      ctx.fillStyle = cor;
      pts.forEach(p => {
        if (!p) return;
        ctx.beginPath();
        ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
        ctx.fill();
      });

      ctx.restore();
    }

    if (manha) drawSeries(manha.valores, corManha);
    if (tarde) drawSeries(tarde.valores, corTarde);

    // legenda
    ctx.save();
    ctx.font = "13px Arial";
    ctx.fillStyle = "rgba(255,255,255,0.9)";

    function legendaItem(x, y, cor, texto) {
      ctx.fillStyle = cor;
      ctx.fillRect(x, y - 10, 18, 4);
      ctx.fillStyle = "rgba(255,255,255,0.9)";
      ctx.fillText(texto, x + 24, y - 6);
    }

    const legY = 16;
    legendaItem(padding.left, legY, corManha, manha ? `Manh√£ (${manha.dataHora.split(" ")[1]})` : "Manh√£ (sem registro)");
    legendaItem(padding.left + 250, legY, corTarde, tarde ? `Tarde (${tarde.dataHora.split(" ")[1]})` : "Tarde (sem registro)");

    ctx.restore();

    if (!manha && !tarde) {
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,0.8)";
      ctx.font = "14px Arial";
      ctx.fillText("Nenhum teste de Wi-Fi registrado hoje (06:00‚Äì18:00).", padding.left, padding.top + 40);
      ctx.restore();
    }
  }

  async function carregarEstado() {
    const salvo = await carregarDoSupabase();

    document.querySelector("#tabelaRelatorio tbody").innerHTML = "";
    document.querySelector("#tabelaHistorico tbody").innerHTML = "";

    if (salvo) {
      const localOp = getOperador();
      if (localOp) setOperador(localOp);
      else if (salvo.operador) setOperador(salvo.operador);

      aplicarChecklistSalvo(salvo.checklist);

      if (salvo.wifi && anyWifiPreenchido(salvo.wifi)) {
        preencherValoresWifi(salvo.wifi);
        document.getElementById("subwifi").style.display = "block";
      } else {
        WIFI_INPUT_IDS.forEach(id => { document.getElementById(id).value = ""; });
        document.getElementById("subwifi").style.display = "none";
      }

      relatorioCache = Array.isArray(salvo.relatorio) ? salvo.relatorio.slice() : [];
      preencherFiltros(relatorioCache);

      desenharRelatorioHoje();
      desenharGraficoWifi();
    } else {
      desenharGraficoWifi();
    }

    const temaClaro = localStorage.getItem('temaClaro') === 'true';
    if (temaClaro) document.body.classList.add('light');

    if (window.matchMedia("(max-width: 768px)").matches) {
      document.querySelector(".historico").setAttribute("data-collapsed", "true");
    }

    WIFI_INPUT_IDS.forEach(id => {
      const el = document.getElementById(id);
      if (!el._listenerBound) {
        el.addEventListener("input", () => {
          const cb = document.getElementById("tarefa5");
          const span = cb.parentElement.querySelector("span");

          if (cb.checked && !todosWifiPreenchidos()) {
            cb.checked = false;
            span.classList.remove("checked");
          }

          if (!cb.checked && todosWifiPreenchidos()) {
            autoConcluirWifi();
            return;
          }

          salvarEstado();
        });
        el._listenerBound = true;
      }
    });

    const liWifi = document.getElementById("li-wifi");
    if (!liWifi._listenerBound) {
      liWifi.addEventListener("click", (e) => {
        const tag = e.target.tagName.toLowerCase();
        if (tag === "input") return;
        if (tag === "label" || e.target.closest("label")) return;

        const bloco = document.getElementById("subwifi");
        bloco.style.display = bloco.style.display === "block" ? "none" : "block";
      });
      liWifi._listenerBound = true;
    }

    if (!getOperador()) abrirModalOperador(false);
  }

  function registrarConclusao(checkbox) {
    if (!getOperador()) {
      checkbox.checked = false;
      abrirModalOperador(true);
      return;
    }

    const span = checkbox.parentElement.querySelector("span");
    const tarefa = span.textContent.replace(" ‚úîÔ∏è", "");
    const operador = getOperador() || operadorAtual || "";

    if (checkbox.id === "tarefa5") {
      document.getElementById("subwifi").style.display = "block";

      if (checkbox.checked) {
        if (!todosWifiPreenchidos()) {
          alert("Preencha os 6 campos de velocidade (apenas n√∫meros) para concluir esta tarefa.");
          checkbox.checked = false;
          span.classList.remove("checked");
          salvarEstado();
          return;
        }
        const mapa = {
          "wifi-recepcao": "Recep√ß√£o",
          "wifi-minigolf": "Minigolf",
          "wifi-sorveteria": "Sorveteria",
          "wifi-barpiscina": "Bar Piscina",
          "wifi-pizzaria": "Pizzaria",
          "wifi-pastelaria": "Pastelaria"
        };
        const partes = WIFI_INPUT_IDS
          .map(id => `${mapa[id]} - ${document.getElementById(id).value.trim()} Mbps`);
        const descricao = `Realizar testes de Wi-Fi em √°reas comuns: ${partes.join(", ")}`;

        const horario = new Date().toLocaleString("pt-BR", { timeZone: 'America/Sao_Paulo' });

        if (horario.startsWith(dataHojeBR())) {
          const novaLinhaHoje = document.querySelector("#tabelaRelatorio tbody").insertRow(0);
          novaLinhaHoje.insertCell(0).textContent = descricao;
          novaLinhaHoje.insertCell(1).textContent = operador;
          novaLinhaHoje.insertCell(2).textContent = horario;
        }

        relatorioCache.unshift({ tarefa: descricao, operador, dataHora: horario });

        span.classList.add("checked");
        salvarEstado();
        desenharGraficoWifi();
        return;
      } else {
        span.classList.remove("checked");
        salvarEstado();
        desenharGraficoWifi();
        return;
      }
    }

    span.classList.toggle("checked", checkbox.checked);

    if (checkbox.checked) {
      const horario = new Date().toLocaleString("pt-BR", { timeZone: 'America/Sao_Paulo' });

      if (horario.startsWith(dataHojeBR())) {
        const novaLinhaHoje = document.querySelector("#tabelaRelatorio tbody").insertRow(0);
        novaLinhaHoje.insertCell(0).textContent = tarefa;
        novaLinhaHoje.insertCell(1).textContent = operador;
        novaLinhaHoje.insertCell(2).textContent = horario;
      }

      relatorioCache.unshift({ tarefa, operador, dataHora: horario });
    }

    salvarEstado();
  }

  function autoConcluirWifi() {
    if (!getOperador()) {
      abrirModalOperador(true);
      return;
    }

    const cb = document.getElementById("tarefa5");
    const span = cb.parentElement.querySelector("span");
    const operador = getOperador() || operadorAtual || "";

    const mapa = {
      "wifi-recepcao": "Recep√ß√£o",
      "wifi-minigolf": "Minigolf",
      "wifi-sorveteria": "Sorveteria",
      "wifi-barpiscina": "Bar Piscina",
      "wifi-pizzaria": "Pizzaria",
      "wifi-pastelaria": "Pastelaria"
    };
    const partes = WIFI_INPUT_IDS
      .map(id => `${mapa[id]} - ${document.getElementById(id).value.trim()} Mbps`);
    const descricao = `Realizar testes de Wi-Fi em √°reas comuns: ${partes.join(", ")}`;
    const horario = new Date().toLocaleString("pt-BR", { timeZone: 'America/Sao_Paulo' });

    cb.checked = true;
    span.classList.add("checked");

    if (horario.startsWith(dataHojeBR())) {
      const novaLinhaHoje = document.querySelector("#tabelaRelatorio tbody").insertRow(0);
      novaLinhaHoje.insertCell(0).textContent = descricao;
      novaLinhaHoje.insertCell(1).textContent = operador;
      novaLinhaHoje.insertCell(2).textContent = horario;
    }

    relatorioCache.unshift({ tarefa: descricao, operador, dataHora: horario });
    salvarEstado();
    desenharGraficoWifi();
  }

  function resetarChecklist() {
    document.querySelectorAll('#checklist input[type="checkbox"]').forEach(cb => {
      cb.checked = false;
      cb.parentElement.querySelector("span").classList.remove("checked");
    });
    WIFI_INPUT_IDS.forEach(id => { document.getElementById(id).value = ""; });
    document.getElementById("subwifi").style.display = "none";
    salvarEstado();
    desenharGraficoWifi();
  }

  function resetarRelatorio() {
    document.querySelector('#tabelaRelatorio tbody').innerHTML = "";
    document.querySelector('#tabelaHistorico tbody').innerHTML = "";
    relatorioCache = [];
    salvarEstado();
    desenharGraficoWifi();
  }

  function alternarTema() {
    document.body.classList.toggle('light');
    localStorage.setItem('temaClaro', document.body.classList.contains('light'));
  }

  async function carregarClima() {
    const apiKey = 'f72b6474dc378f01668c752c37748576';
    const cidade = 'Olimpia,BR';
    try {
      const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${cidade}&units=metric&lang=pt_br&appid=${apiKey}`);
      const dados = await r.json();
      if (!dados?.main || !dados?.weather) throw new Error("Resposta inv√°lida");
      document.getElementById('clima').textContent =
        `üå°Ô∏è Ol√≠mpia-SP: ${Math.round(dados.main.temp)}¬∞C, ${dados.weather[0].description}`;
    } catch {
      document.getElementById('clima').textContent = "Erro ao obter clima";
    }
  }

  function preencherFiltros(dados) {
    const anos = new Set(), meses = new Set(), dias = new Set();
    dados.forEach(reg => {
      const [dia, mes, ano] = (reg.dataHora || "").split(" ")[0].split("/");
      if (dia && mes && ano) {
        dias.add(dia); meses.add(mes); anos.add(ano);
      }
    });
    document.getElementById("filtroDia").innerHTML =
      '<option value="">Dia</option>' + [...dias].sort().map(d => `<option>${d}</option>`).join("");
    document.getElementById("filtroMes").innerHTML =
      '<option value="">M√™s</option>' + [...meses].sort().map(m => `<option>${m}</option>`).join("");
    document.getElementById("filtroAno").innerHTML =
      '<option value="">Ano</option>' + [...anos].sort().map(a => `<option>${a}</option>`).join("");
  }

  function aplicarFiltroHistorico() {
    const dia = document.getElementById("filtroDia").value;
    const mes = document.getElementById("filtroMes").value;
    const ano = document.getElementById("filtroAno").value;

    const tbody = document.querySelector("#tabelaHistorico tbody");
    tbody.innerHTML = "";

    if (!dia && !mes && !ano) return;

    relatorioCache.forEach(reg => {
      const [d, m, a] = (reg.dataHora || "").split(" ")[0].split("/");
      if ((!dia || d === dia) && (!mes || m === mes) && (!ano || a === ano)) {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = reg.tarefa;
        row.insertCell(1).textContent = reg.operador || "";
        row.insertCell(2).textContent = reg.dataHora;
      }
    });
  }

  function limparFiltroHistorico() {
    document.getElementById("filtroDia").value = "";
    document.getElementById("filtroMes").value = "";
    document.getElementById("filtroAno").value = "";
    document.querySelector("#tabelaHistorico tbody").innerHTML = "";
  }

  // --- loader robusto para jsPDF (tenta import ESM e cai para <script>) ---
  let _jsPDFCtor = null;
  async function getJsPDF() {
    if (_jsPDFCtor) return _jsPDFCtor;

    try {
      const mod = await import("https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js");
      _jsPDFCtor = mod.jsPDF || (mod.default && mod.default.jsPDF);
    } catch (e) {}

    if (!_jsPDFCtor) {
      await new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
        s.onload = resolve;
        s.onerror = () => reject(new Error("Falha ao carregar jsPDF via CDN"));
        document.head.appendChild(s);
      });
      _jsPDFCtor = window.jspdf && window.jspdf.jsPDF;
    }

    if (!_jsPDFCtor) throw new Error("N√£o foi poss√≠vel carregar o jsPDF.");
    return _jsPDFCtor;
  }

  async function exportarPDF() {
    try {
      const jsPDF = await getJsPDF();
      const doc = new jsPDF({ unit: "mm", format: "a4" });

      const margin = 10;
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      const colDataWidth = 50;
      const colOperWidth = 35;
      const colTaskWidth = pageWidth - margin * 2 - colDataWidth - colOperWidth;

      const xTask = margin;
      const xOper = margin + colTaskWidth + 2;
      const xData = margin + colTaskWidth + colOperWidth + 2;

      function desenharCabecalho() {
        doc.setFontSize(16);
        doc.text("Hist√≥rico de Relat√≥rios - Checklist T.I Solar", margin, 15);

        doc.setFontSize(12);
        doc.text("Tarefa", xTask, 25);
        doc.text("Operador", xOper, 25);
        doc.text("Data e Hora", xData, 25);
      }

      desenharCabecalho();

      let y = 33;
      const linhaAlt = 6;

      const dados = relatorioCache.length
        ? relatorioCache
        : [{ tarefa: "Nenhum relat√≥rio dispon√≠vel.", operador: "", dataHora: "" }];

      dados.forEach((reg) => {
        const tarefaTxt = reg.tarefa || "";
        const operTxt = reg.operador || "";
        const dataTxt = reg.dataHora || "";

        const linhasTarefa = doc.splitTextToSize(tarefaTxt, colTaskWidth);
        const linhasOper = doc.splitTextToSize(operTxt, colOperWidth);

        const linhasBloco = Math.max(linhasTarefa.length, linhasOper.length, 1);
        const blocoAltura = Math.max(linhasBloco * linhaAlt, 10);

        if (y + blocoAltura > pageHeight - margin) {
          doc.addPage();
          desenharCabecalho();
          y = 33;
        }

        linhasTarefa.forEach((linha, i) => doc.text(linha, xTask, y + i * linhaAlt));
        linhasOper.forEach((linha, i) => doc.text(linha, xOper, y + i * linhaAlt));
        doc.text(dataTxt, xData, y);

        y += blocoAltura;
      });

      doc.save("relatorio_checklist.pdf");
    } catch (err) {
      console.error(err);
      alert("N√£o foi poss√≠vel exportar o PDF. Verifique sua conex√£o e tente novamente.");
    }
  }

  window.registrarConclusao = registrarConclusao;
  window.resetarChecklist = resetarChecklist;
  window.resetarRelatorio = resetarRelatorio;
  window.alternarTema = alternarTema;
  window.aplicarFiltroHistorico = aplicarFiltroHistorico;
  window.limparFiltroHistorico = limparFiltroHistorico;
  window.exportarPDF = exportarPDF;

  // init
  carregarEstado();
  carregarClima();
  setInterval(carregarClima, 1800000);

  // realtime
  supabase
    .channel('relatorio-ti-realtime')
    .on('postgres_changes',
      { event: '*', schema: 'public', table: 'relatorio_t' },
      async (_payload) => {
        const salvo = await carregarDoSupabase();
        if (salvo) {
          relatorioCache = Array.isArray(salvo.relatorio) ? salvo.relatorio.slice() : [];
          preencherFiltros(relatorioCache);
          desenharRelatorioHoje();
          desenharGraficoWifi();

          if (!getOperador() && salvo.operador) setOperador(salvo.operador);
        }
      }
    )
    .subscribe();

</script>
</body>
</html>
