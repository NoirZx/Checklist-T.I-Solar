<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Checklist Di√°rio T.I Solar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="icone.ico" type="image/x-icon">
  <style>
    :root {
      --bg-color: #121212;
      --card-color: #1e1e1e;
      --text-color: #e0e0e0;
      --accent: #00ffcc;
    }
    body.light {
      --bg-color: #f0f0f0;
      --card-color: #ffffff;
      --text-color: #111111;
      --accent: #00796b;
      background-image: none;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-image: url('fundo.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      z-index: -1;
    }
    header {
      position: relative;
      padding: 20px 40px;
    }
    h1 {
      text-align: center;
      font-size: 3em;
      color: var(--accent);
      margin: 0;
    }
    .info {
      position: absolute;
      top: 20px;
      right: 40px;
      text-align: right;
      font-size: 1em;
    }
    .controls {
      position: absolute;
      top: 20px;
      left: 40px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .main-controls,
    .secondary-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button {
      background-color: var(--card-color);
      color: var(--text-color);
      border: 1px solid var(--accent);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background-color: var(--accent);
      color: #000;
    }
    main { padding: 40px; }
    .container-flex {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
    }
    .checklist {
      flex: 1;
      min-width: 300px;
    }
    .relatorio {
      flex: 1;
      min-width: 300px;
      background-color: var(--card-color);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--accent);
    }
    ul {
      list-style-type: decimal;
      padding-left: 20px;
      margin: 0;
      max-width: 700px;
    }
    li {
      background-color: var(--card-color);
      margin-bottom: 20px;
      padding: 20px;
      border-radius: 10px;
      font-size: 1.5em;
    }
    li label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      border-left: 5px solid var(--accent);
      padding-left: 10px;
    }
    li span { transition: color 0.3s ease, text-decoration 0.3s ease; }
    input[type="checkbox"] {
      transform: scale(1.5);
      cursor: pointer;
      accent-color: var(--accent);
    }
    .checked { text-decoration: line-through; color: gray; }
    .checked::after { content: " ‚úîÔ∏è"; font-size: 0.8em; }

    table { width: 100%; border-collapse: collapse; color: var(--text-color); }
    th, td { border: 1px solid var(--accent); padding: 8px; text-align: left; }
    th { background-color: var(--accent); color: black; }

    .historico {
      background-color: var(--card-color);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--accent);
      margin-top: 40px;
    }
    .filtros {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    /* Sub-checklist Wi-Fi */
    .subwifi {
      margin-top: 14px;
      padding: 14px;
      border: 1px dashed var(--accent);
      border-radius: 10px;
      background: rgba(0,0,0,0.2);
      display: none;
    }
    .subwifi .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 10px;
    }
    .subwifi label {
      font-size: 0.9em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: var(--card-color);
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .subwifi input[type="number"] {
      width: 110px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--accent);
      background: #00000033;
      color: var(--text-color);
      font-size: 0.95em;
    }
    .hint {
      margin-top: 8px;
      font-size: 0.85em;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <header>
    <div class="controls">
      <div class="main-controls">
        <button onclick="alternarTema()">üåó Alternar Tema</button>
        <button onclick="resetarRelatorio()">üóëÔ∏è Limpar Relat√≥rio</button>
      </div>
      <div class="secondary-controls">
        <button onclick="resetarChecklist()">üîÅ Resetar Checklist</button>
      </div>
    </div>
    <h1>Checklist Di√°rio T.I Solar</h1>
    <div class="info">
      <span id="hora">‚è∞ Carregando hora...</span>
      <span id="clima">üå°Ô∏è Carregando clima...</span>
    </div>
  </header>

  <main>
    <div class="container-flex">
      <div class="checklist">
        <ul id="checklist">
          <li>
            <input type="checkbox" id="tarefa1" onclick="registrarConclusao(this)">
            <label for="tarefa1"><span>Verificar equipamentos do Data Center</span></label>
          </li>
          <li>
            <input type="checkbox" id="tarefa2" onclick="registrarConclusao(this)">
            <label for="tarefa2"><span>Validar a disponibilidade dos canais de TV</span></label>
          </li>
          <li>
            <input type="checkbox" id="tarefa3" onclick="registrarConclusao(this)">
            <label for="tarefa3"><span>Validar chamados em aberto</span></label>
          </li>
          <li>
            <input type="checkbox" id="tarefa4" onclick="registrarConclusao(this)">
            <label for="tarefa4"><span>Validar as telas com banner do marketing na recep√ß√£o</span></label>
          </li>

          <!-- Tarefa Wi-Fi com sub-checklist -->
          <li id="li-wifi">
            <input type="checkbox" id="tarefa5" onclick="registrarConclusao(this)">
            <label for="tarefa5"><span>Realizar testes de Wi-Fi em √°reas comuns</span></label>

            <div id="subwifi" class="subwifi">
              <div class="grid">
                <label>Recep√ß√£o
                  <input type="number" id="wifi-recepcao" min="0" step="1" inputmode="numeric" placeholder="Mbps">
                </label>
                <label>Minigolf
                  <input type="number" id="wifi-minigolf" min="0" step="1" inputmode="numeric" placeholder="Mbps">
                </label>
                <label>Sorveteria
                  <input type="number" id="wifi-sorveteria" min="0" step="1" inputmode="numeric" placeholder="Mbps">
                </label>
                <label>Bar Piscina
                  <input type="number" id="wifi-barpiscina" min="0" step="1" inputmode="numeric" placeholder="Mbps">
                </label>
                <label>Pizzaria
                  <input type="number" id="wifi-pizzaria" min="0" step="1" inputmode="numeric" placeholder="Mbps">
                </label>
                <label>Pastelaria
                  <input type="number" id="wifi-pastelaria" min="0" step="1" inputmode="numeric" placeholder="Mbps">
                </label>
              </div>
              <div class="hint">Preencha todos os 6 campos. A tarefa s√≥ ser√° conclu√≠da quando todos estiverem preenchidos.</div>
            </div>
          </li>

          <li>
            <input type="checkbox" id="tarefa6" onclick="registrarConclusao(this)">
            <label for="tarefa6"><span>Verificar TVs com Pix Media nas √Åreas</span></label>
          </li>
        </ul>
      </div>

      <div class="relatorio">
        <h2>‚úÖ Relat√≥rio de Conclus√£o (Hoje)</h2>
        <table id="tabelaRelatorio">
          <thead>
            <tr><th>Tarefa</th><th>Data e Hora</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="historico">
      <h2>üìú Hist√≥rico de Relat√≥rios</h2>
      <div class="filtros">
        <select id="filtroDia"><option value="">Dia</option></select>
        <select id="filtroMes"><option value="">M√™s</option></select>
        <select id="filtroAno"><option value="">Ano</option></select>
        <button onclick="aplicarFiltroHistorico()">Filtrar</button>
        <button onclick="limparFiltroHistorico()">Limpar Filtros</button>
      </div>
      <table id="tabelaHistorico">
        <thead>
          <tr><th>Tarefa</th><th>Data e Hora</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://dpcmfkojothqxoaxgqxm.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwY21ma29qb3RocXhvYXhncXhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NjA5NDMsImV4cCI6MjA3MDMzNjk0M30.ZLXoh8rNehb1We_qvlNvonuJohzYEno83OXjciJyTr4";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  const WIFI_INPUT_IDS = [
    "wifi-recepcao","wifi-minigolf","wifi-sorveteria",
    "wifi-barpiscina","wifi-pizzaria","wifi-pastelaria"
  ];

  function dataHojeBR() {
    const hoje = new Date();
    return hoje.toLocaleDateString("pt-BR", { timeZone: 'America/Sao_Paulo' });
  }

  function atualizarHora() {
    const data = new Date();
    const opcoes = { timeZone: 'America/Sao_Paulo', hour: '2-digit', minute: '2-digit', second: '2-digit' };
    document.getElementById('hora').textContent = `‚è∞ Hor√°rio de Bras√≠lia: ${new Intl.DateTimeFormat('pt-BR', opcoes).format(data)}`;
  }
  setInterval(atualizarHora, 1000);
  atualizarHora();

  async function salvarNoSupabase(checklist, relatorio, wifi) {
    try {
      const { error } = await supabase
        .from("relatorio_t.i")
        .upsert({
          id: 1,
          checklist,
          relatorio,
          wifi, // guardamos tamb√©m os valores dos testes de Wi-Fi
          atualizado_em: new Date().toISOString()
        })
        .select();
      if (error) throw error;
    } catch (err) {
      console.warn("Erro ao salvar no Supabase, fallback localStorage:", err);
      localStorage.setItem("estadoChecklistTI", JSON.stringify({ checklist, relatorio, wifi }));
    }
  }

  async function carregarDoSupabase() {
    try {
      const { data, error } = await supabase
        .from("relatorio_t.i")
        .select("*")
        .eq("id", 1)
        .single();
      if (error || !data) throw error || new Error("Sem dados");
      return {
        checklist: data.checklist || [],
        relatorio: data.relatorio || [],
        wifi: data.wifi || null
      };
    } catch (err) {
      console.warn("Erro ao carregar do Supabase, usando localStorage:", err);
      return JSON.parse(localStorage.getItem("estadoChecklistTI")) || null;
    }
  }

  function coletarValoresWifi() {
    const vals = {};
    WIFI_INPUT_IDS.forEach(id => {
      const el = document.getElementById(id);
      vals[id] = el?.value?.trim() ?? "";
    });
    return vals;
  }

  function preencherValoresWifi(vals) {
    if (!vals) return;
    WIFI_INPUT_IDS.forEach(id => {
      if (vals[id] !== undefined) {
        const el = document.getElementById(id);
        el.value = vals[id];
      }
    });
  }

  function todosWifiPreenchidos() {
    return WIFI_INPUT_IDS.every(id => {
      const v = (document.getElementById(id).value || "").trim();
      return v !== "" && !isNaN(Number(v));
    });
  }

  async function salvarEstado() {
    const checklist = [...document.querySelectorAll("#checklist li")].map(li => {
      const span = li.querySelector("span");
      const tarefa = span.textContent.replace(" ‚úîÔ∏è", "");
      const marcado = li.querySelector("input").checked;
      return { tarefa, marcado };
    });
    const relatorio = [...document.querySelectorAll("#tabelaHistorico tbody tr")].map(tr => ({
      tarefa: tr.cells[0].textContent, dataHora: tr.cells[1].textContent
    }));
    const wifi = coletarValoresWifi();
    await salvarNoSupabase(checklist, relatorio, wifi);
  }

  async function carregarEstado() {
    const salvo = await carregarDoSupabase();
    if (salvo) {
      // Restaurar checklist marcado
      document.querySelector("#tabelaRelatorio tbody").innerHTML = "";
      salvo.checklist.forEach(itemSalvo => {
        document.querySelectorAll("#checklist li").forEach(li => {
          const span = li.querySelector("span");
          if (span.textContent.includes(itemSalvo.tarefa)) {
            const checkbox = li.querySelector("input");
            checkbox.checked = itemSalvo.marcado;
            span.classList.toggle("checked", itemSalvo.marcado);
            // Se for a tarefa de Wi-Fi, restaurar valores e mostrar bloco
            if (li.id === "li-wifi") {
              if (salvo.wifi) preencherValoresWifi(salvo.wifi);
              document.getElementById("subwifi").style.display = "block"; // deixa vis√≠vel ao carregar (facilita revis√£o)
            }
            // Preencher relat√≥rio de hoje (se j√° houver registro salvo de hoje)
            if (itemSalvo.marcado) {
              const dataHora = salvo.relatorio.find(r => r.tarefa === itemSalvo.tarefa)?.dataHora;
              if (dataHora?.startsWith(dataHojeBR())) {
                const row = document.querySelector("#tabelaRelatorio tbody").insertRow();
                row.insertCell(0).textContent = itemSalvo.tarefa;
                row.insertCell(1).textContent = dataHora;
              }
            }
          }
        });
      });
      preencherFiltros(salvo.relatorio);
    }
    const temaClaro = localStorage.getItem('temaClaro') === 'true';
    if (temaClaro) document.body.classList.add('light');

    // Listeners para validar Wi-Fi em tempo real e salvar
    WIFI_INPUT_IDS.forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("input", () => {
        // Se a tarefa estiver marcada e algum campo for apagado, desfaz a conclus√£o
        const cb = document.getElementById("tarefa5");
        if (cb.checked && !todosWifiPreenchidos()) {
          cb.checked = false;
          cb.parentElement.querySelector("span").classList.remove("checked");
          // N√£o removemos linhas antigas do relat√≥rio para manter o hist√≥rico, como no restante do app
        }
        salvarEstado();
      });
    });

    // Sempre mostrar o bloco ao clicar na linha da tarefa de Wi-Fi
    document.getElementById("li-wifi").addEventListener("click", (e) => {
      // Evita esconder/mostrar quando clicamos nos inputs
      if (e.target.tagName.toLowerCase() === "input" && e.target.type === "number") return;
      document.getElementById("subwifi").style.display = "block";
    });
  }

  function registrarConclusao(checkbox) {
    const span = checkbox.parentElement.querySelector("span");
    const tarefa = span.textContent.replace(" ‚úîÔ∏è", "");

    // Caso especial: Wi-Fi
    if (checkbox.id === "tarefa5") {
      // Sempre mostrar o bloco ao interagir
      document.getElementById("subwifi").style.display = "block";

      if (checkbox.checked) {
        if (!todosWifiPreenchidos()) {
          alert("Preencha os 6 campos de velocidade (apenas n√∫meros) para concluir esta tarefa.");
          checkbox.checked = false;
          span.classList.remove("checked");
          salvarEstado();
          return;
        }
        // Monta descri√ß√£o com Mbps
        const mapa = {
          "wifi-recepcao": "Recep√ß√£o",
          "wifi-minigolf": "Minigolf",
          "wifi-sorveteria": "Sorveteria",
          "wifi-barpiscina": "Bar Piscina",
          "wifi-pizzaria": "Pizzaria",
          "wifi-pastelaria": "Pastelaria"
        };
        const partes = WIFI_INPUT_IDS.map(id => `${mapa[id]} - ${document.getElementById(id).value.trim()} Mbps`);
        const descricao = `Realizar testes de Wi-Fi em √°reas comuns: ${partes.join(", ")}`;

        // Relat√≥rio de hoje
        const horario = new Date().toLocaleString("pt-BR", { timeZone: 'America/Sao_Paulo' });
        if (horario.startsWith(dataHojeBR())) {
          const novaLinhaHoje = document.querySelector("#tabelaRelatorio tbody").insertRow(0);
          novaLinhaHoje.insertCell(0).textContent = descricao;
          novaLinhaHoje.insertCell(1).textContent = horario;
        }
        // Hist√≥rico
        const novaLinhaHist = document.querySelector("#tabelaHistorico tbody").insertRow(0);
        novaLinhaHist.insertCell(0).textContent = descricao;
        novaLinhaHist.insertCell(1).textContent = new Date().toLocaleString("pt-BR", { timeZone: 'America/Sao_Paulo' });

        // Visual
        span.classList.add("checked");
        salvarEstado();
        return;
      } else {
        // Desmarcando: apenas tira visual e salva
        span.classList.remove("checked");
        salvarEstado();
        return;
      }
    }

    // Fluxo padr√£o para demais tarefas
    span.classList.toggle("checked", checkbox.checked);
    if (checkbox.checked) {
      const horario = new Date().toLocaleString("pt-BR", { timeZone: 'America/Sao_Paulo' });
      if (horario.startsWith(dataHojeBR())) {
        const novaLinhaHoje = document.querySelector("#tabelaRelatorio tbody").insertRow(0);
        novaLinhaHoje.insertCell(0).textContent = tarefa;
        novaLinhaHoje.insertCell(1).textContent = horario;
      }
      const novaLinhaHist = document.querySelector("#tabelaHistorico tbody").insertRow(0);
      novaLinhaHist.insertCell(0).textContent = tarefa;
      novaLinhaHist.insertCell(1).textContent = new Date().toLocaleString("pt-BR", { timeZone: 'America/Sao_Paulo' });
    }
    salvarEstado();
  }

  function resetarChecklist() {
    document.querySelectorAll('#checklist input[type="checkbox"]').forEach(cb => {
      cb.checked = false;
      cb.parentElement.querySelector("span").classList.remove("checked");
    });
    // Limpar campos Wi-Fi e esconder bloco
    WIFI_INPUT_IDS.forEach(id => { document.getElementById(id).value = ""; });
    document.getElementById("subwifi").style.display = "none";
    salvarEstado();
  }

  function resetarRelatorio() {
    document.querySelector('#tabelaRelatorio tbody').innerHTML = "";
    document.querySelector('#tabelaHistorico tbody').innerHTML = "";
    salvarEstado();
  }

  function alternarTema() {
    document.body.classList.toggle('light');
    localStorage.setItem('temaClaro', document.body.classList.contains('light'));
  }

  async function carregarClima() {
    const apiKey = 'f72b6474dc378f01668c752c37748576'; // <- Substitua pela sua chave real
    const cidade = 'Olimpia,BR';
    try {
      const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${cidade}&units=metric&lang=pt_br&appid=${apiKey}`);
      const dados = await r.json();
      if (!dados?.main || !dados?.weather) throw new Error("Resposta inv√°lida");
      document.getElementById('clima').textContent = `üå°Ô∏è Ol√≠mpia-SP: ${Math.round(dados.main.temp)}¬∞C, ${dados.weather[0].description}`;
    } catch {
      document.getElementById('clima').textContent = "Erro ao obter clima";
    }
  }

  function preencherFiltros(dados) {
    const anos = new Set(), meses = new Set(), dias = new Set();
    dados.forEach(reg => {
      const [dia, mes, ano] = reg.dataHora.split(" ")[0].split("/");
      dias.add(dia); meses.add(mes); anos.add(ano);
    });
    document.getElementById("filtroDia").innerHTML = '<option value="">Dia</option>' + [...dias].sort().map(d => `<option>${d}</option>`).join("");
    document.getElementById("filtroMes").innerHTML = '<option value="">M√™s</option>' + [...meses].sort().map(m => `<option>${m}</option>`).join("");
    document.getElementById("filtroAno").innerHTML = '<option value="">Ano</option>' + [...anos].sort().map(a => `<option>${a}</option>`).join("");
  }

  function aplicarFiltroHistorico() {
    const dia = document.getElementById("filtroDia").value;
    const mes = document.getElementById("filtroMes").value;
    const ano = document.getElementById("filtroAno").value;
    const tbody = document.querySelector("#tabelaHistorico tbody");
    tbody.innerHTML = "";
    carregarDoSupabase().then(salvo => {
      if (!salvo) return;
      salvo.relatorio.forEach(reg => {
        const [d, m, a] = reg.dataHora.split(" ")[0].split("/");
        if ((!dia || d === dia) && (!mes || m === mes) && (!ano || a === ano)) {
          const row = tbody.insertRow();
          row.insertCell(0).textContent = reg.tarefa;
          row.insertCell(1).textContent = reg.dataHora;
        }
      });
    });
  }

  function limparFiltroHistorico() {
    document.getElementById("filtroDia").value = "";
    document.getElementById("filtroMes").value = "";
    document.getElementById("filtroAno").value = "";
    document.querySelector("#tabelaHistorico tbody").innerHTML = "";
  }

  window.registrarConclusao = registrarConclusao;
  window.resetarChecklist = resetarChecklist;
  window.resetarRelatorio = resetarRelatorio;
  window.alternarTema = alternarTema;
  window.aplicarFiltroHistorico = aplicarFiltroHistorico;
  window.limparFiltroHistorico = limparFiltroHistorico;

  carregarEstado();
  carregarClima();
  setInterval(carregarClima, 1800000);
</script>
</body>
</html>
